package com.vietmap.app

import android.app.*
import android.content.Context
import android.content.Intent
import android.location.Location
import android.location.LocationListener
import android.location.LocationManager
import android.os.Binder
import android.os.Build
import android.os.Bundle
import android.os.IBinder
import android.speech.tts.TextToSpeech
import android.util.Log
import androidx.core.app.NotificationCompat
import io.flutter.embedding.engine.FlutterEngine
import io.flutter.embedding.engine.dart.DartExecutor
import io.flutter.plugin.common.EventChannel
import io.flutter.plugin.common.MethodChannel
import java.util.*

/**
 * Foreground service for GPS tracking and warning engine
 * Sends location updates to Flutter via EventChannel
 * Receives TTS requests via MethodChannel
 */
class HybridService : Service(), LocationListener, TextToSpeech.OnInitListener {
    private val binder = LocalBinder()
    private var locationManager: LocationManager? = null
    private var tts: TextToSpeech? = null
    private var eventSink: EventChannel.EventSink? = null
    private var flutterEngine: FlutterEngine? = null
    private val channel = "OC_WARNING_SERVICE"

    inner class LocalBinder : Binder() {
        fun getService(): HybridService = this@HybridService
    }

    override fun onCreate() {
        super.onCreate()
        Log.d(TAG, "HybridService: onCreate")

        // Initialize Flutter engine
        flutterEngine = FlutterEngine(this)
        flutterEngine?.dartExecutor.executeDartEntrypoint(
            DartExecutor.DartEntrypoint.createDefault()
        )

        // Setup EventChannel for location stream
        EventChannel(flutterEngine!!.dartExecutor.binaryMessenger, "com.vietmap/location_stream")
            .setStreamHandler(object : EventChannel.StreamHandler {
                override fun onListen(arguments: Any?, events: EventChannel.EventSink?) {
                    eventSink = events
                    Log.d(TAG, "EventChannel: onListen")
                }

                override fun onCancel(arguments: Any?) {
                    eventSink = null
                    Log.d(TAG, "EventChannel: onCancel")
                }
            })

        // Setup MethodChannel for TTS
        MethodChannel(flutterEngine!!.dartExecutor.binaryMessenger, "com.vietmap/foreground_location")
            .setMethodCallHandler { call, result ->
                when (call.method) {
                    "requestTTS" -> {
                        val text = call.argument<String>("text")
                        if (text != null) {
                            speak(text)
                            result.success(true)
                        } else {
                            result.error("INVALID_ARG", "Text is null", null)
                        }
                    }
                    else -> result.notImplemented()
                }
            }

        // Initialize location manager
        locationManager = getSystemService(Context.LOCATION_SERVICE) as LocationManager

        // Initialize TTS
        tts = TextToSpeech(this, this)

        // Start foreground service
        startForeground(1001, buildNotification("VietMap Warning active"))
    }

    override fun onStartCommand(intent: Intent?, flags: Int, startId: Int): Int {
        Log.d(TAG, "HybridService: onStartCommand")
        startLocationUpdates()
        return START_STICKY
    }

    private fun startLocationUpdates() {
        try {
            locationManager?.requestLocationUpdates(
                LocationManager.GPS_PROVIDER,
                200, // minTime (ms) - adaptive will be handled in Dart
                5f,  // minDistance (meters)
                this
            )
            Log.d(TAG, "Location updates started")
        } catch (e: SecurityException) {
            Log.e(TAG, "Location permission not granted", e)
        }
    }

    override fun onLocationChanged(location: Location) {
        val data = mapOf(
            "lat" to location.latitude,
            "lng" to location.longitude,
            "speed" to location.speed,
            "accuracy" to location.accuracy,
            "timestamp" to location.time
        )
        eventSink?.success(data)
        Log.d(TAG, "Location: ${location.latitude}, ${location.longitude}")
    }

    private fun speak(text: String) {
        tts?.speak(text, TextToSpeech.QUEUE_ADD, null, "VIETMAP_TTS")
        Log.d(TAG, "TTS: $text")
    }

    private fun buildNotification(text: String): Notification {
        val channelId = if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O) {
            createNotificationChannel()
        } else {
            channel
        }

        val intent = Intent(this, MainActivity::class.java)
        val pendingIntent = PendingIntent.getActivity(
            this, 0, intent,
            PendingIntent.FLAG_UPDATE_CURRENT or PendingIntent.FLAG_IMMUTABLE
        )

        return NotificationCompat.Builder(this, channelId)
            .setContentTitle("VietMap")
            .setContentText(text)
            .setSmallIcon(android.R.drawable.ic_dialog_info)
            .setContentIntent(pendingIntent)
            .setOngoing(true)
            .build()
    }

    private fun createNotificationChannel(): String {
        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O) {
            val channel = NotificationChannel(
                channel,
                "VietMap Warning Service",
                NotificationManager.IMPORTANCE_LOW
            ).apply {
                description = "Foreground service for GPS warnings"
            }
            val notificationManager = getSystemService(NotificationManager::class.java)
            notificationManager.createNotificationChannel(channel)
        }
        return channel
    }

    override fun onInit(status: Int) {
        if (status == TextToSpeech.SUCCESS) {
            tts?.language = Locale("vi", "VN")
            Log.d(TAG, "TTS initialized")
        }
    }

    override fun onBind(intent: Intent?): IBinder = binder

    override fun onDestroy() {
        super.onDestroy()
        locationManager?.removeUpdates(this)
        tts?.stop()
        tts?.shutdown()
        flutterEngine?.destroy()
        Log.d(TAG, "HybridService: onDestroy")
    }

    companion object {
        private const val TAG = "HybridService"
    }
}

